---
title: "Uso básico del paquete casen"
author: "Mauricio Vargas"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Uso básico del paquete casen}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, cache = FALSE, echo = FALSE, message = FALSE, warning = FALSE, tidy = FALSE}
knitr::opts_chunk$set(eval = TRUE)
```

# Leer datos

Con el paquete `casen` podemos leer la encuesta en formato rar o zip. También es posible leer directamente en formato sav (SPSS) o dta (Stata).

Vamos a leer un subconjunto de los datos proporcionado por este paquete:
```{r}
library(casen)
r14 <- leer_casen(system.file(package = "casen", "extdata", "casen_2017_los_rios.zip"))
r14
```

Para descargar la encuesta CASEN hay varias opciones:
```{r, eval=FALSE}
# todos los anios disponibles
descargar_casen()

# solo anio 2017
descargar_casen(2017)

# todos los anios disponibles en carpeta descargas
descargar_casen("descargas")

# solo anio 2017 en carpeta descargas
descargar_casen(2017, "descargas")
```

# Diseños complejos

El valor agregado del paquete CASEN es que entrega una forma fácil de hacer cálculos tomando en cuenta, además del
diseño complejo, los grados de libertad.

En el contexto de muestreo bietápico, el cálculo de los grados de libertad es un tema no resuelto, pero el paquete casen utiliza la siguiente definición del INE: "Los grados de libertad corresponden a la diferencia entre el número de conglomerados no vacíos (con presencia de la variable de interés) y el número de estratos no vacíos".

En dominios de estimación pequeños la pérdida de grados de libertad se vuelve bastante relevante. Esto es muy importante cuando se hacen cálculos agrupando por región, sexo, región y sexo, entre otras.

Al usar la función `svyby` del paquete survey, la función no calcula correctamente los grados de libertad de cada dominio, sino que considera un valor fijo para todos los dominios. Las funciones del paquete casen usan esta función pero incluyen una serie de pasos programados para usar los grados de libertad adecuados para cada dominio de estimación.

```{r}
# disenio complejo a partir de  los datos leidos
cd <- configuracion_disenio(r14, "ytotcorh", c("comuna", "sexo"), "expc")
cd$disenio
cd$grupos
```

# Medidas de tendencia central con diseño complejo

La función `estadistica_descriptiva()` toma en cuenta el diseño complejo y los grados de libertad. Puedo agrupar por una o más variables y la función entrega, además del promedio, el intervalo de confianza.

*Importante:* El conjunto de datos `r14` se incluye con este software para efectos de mostrar el uso de las funciones, 
la encuesta CASEN *no* asegura representatividad a nivel comunal.

```{r}
# Media, mediana y percentil 70
media_agrupada(cd)
mediana_agrupada(cd)
percentiles_agrupados(cd)
```

# Uso de las funciones de casen y dplyr

Las funciones de `casen` están pensadas para usarse en conjunto con las de `dplyr`. Un ejemplo simple de esto es el cálculo del porcentaje de hogares pobres.

Veamos el caso puntual de las funciones `mutate` y `filter` de dplyr:
```{r}
library(dplyr)

# con mutate puedo convertir pobreza a una variable binaria
r14 %>% 
  mutate(pobreza = ifelse(pobreza <= 2, 1, 0)) %>% 
  configuracion_disenio("pobreza", "comuna", "expc") %>% 
  media_agrupada()
```

```{r, eval=FALSE}
# con filter puedo dejar las observaciones de la 10ma region u otra
leer_casen("2017_spss.rar") %>% 
  filter(region == 10)
```

# Inferencia con diseños complejos

El paquete casen provee dos funciones para sacar el máximo partido
a las funciones de R tomando en cuenta el diseño complejo y los grados de libertad.

Ajuste del modelo:
```{r}
# modelo: ytotcorh = b0 + b1 comuna + b2 sexo + e
mod <- modelo_lineal_generalizado(cd, "ytotcorh ~ comuna + sexo")
summary(mod)
```

# Uso de las funciones de casen con paquetes "tidy"

Además de dplyr, casen se integra perfectamente con los paquetes del 
[Tidyverse](https://www.tidyverse.org/) y otros paquetes que van en la línea
de expresar las salidas como tablas.

Por ejemplo, el paquete broom permite obtener una tabla con los intervalos
de confianza para los betas estimados del modelo.

```{r}
library(broom)
library(survey)
library(janitor)

# usamos ddf y degf del paquete survey para hacer el mismo calculo
# que realiza Stata
mod_conf <- confint_tidy(mod, ddf = degf(cd$disenio))
mod_conf
```

Lo anterior se puede ordenar y presentar los betas junto con los intervalos
de confianza.

```{r}
# ordenamos la salida del modelo usando la funcion tidy (broom)
mod_betas <- tidy(mod)

# pegamos las columnas con bind_cols (dplyr)
mod_betas <- bind_cols(mod_betas, mod_conf)

# clean_names (janitor) ordena los nombres de las columnas
mod_betas <- clean_names(mod_betas)

mod_betas
```
